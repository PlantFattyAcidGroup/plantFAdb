<% content_for :title do -%>
 PlantFAdb: Datasets
<% end -%>

<% content_for :description do -%>
  Information on more than 2000 publications on plant fatty acids with links to species analyzed, analytical data, and full text of publications
<% end -%>

<% content_for :top_bar do %>
	<h1 class="pagetitle">Dataset Listing</h1>
  <p>
    Information on more than 2000 publications on plant fatty acids with links to species analyzed, analytical data, and full text of publications
  </p>
	<% if @plant %>
		<p>
			Filtering on plant: <b><%= link_to @plant.display_name, @plant %></b>
		</p>
	<% end %>
	<% if @pub %>
		<p>
			Filtering on publication: <b><%= link_to @pub.display_name, @pub %></b>
		</p>
	<% end %>
<% end %>

<% content_for :item_bar do %>
    <%= link_to 'Download', params.merge(format: 'csv'), class: 'btn btn-primary'%>
<% end %>

<div class='row'>
	<div class='col-xs-12 col-sm-7 col-md-8 pull-left'>
		<ul class="pagination">
			<%= paginate @datasets %>
		</ul>
	</div>
	<div class='col-xs-12 col-sm-5 col-md-4 search'>
    <%= form_tag nil, method: :get do %>
		<% params.except(:commit,:action,:controller,:utf8,:query).each do |parameter, val| %>
			<%= hidden_field_tag parameter, val %>
		<% end %>
      <div class='form-inline pull-left-sm pull-right-md'>
				<div class='form-group'>
          <a href='<%= Page.path('help') %>' class='glyphicon glyphicon-question-sign' data-toggle='tooltip' data-html='true' title="
            Simple search includes Author, title, journal, abstract, and year from publication. Order, family, Genus, species and common name from plant. Tissue, lipid type and external reference ID from the dataset.<br/><br/>
            
            Click for more details.
          "></a>
			    <label for="query">Search:</label>
					<%= text_field_tag :query, params[:query], class: 'form-control' %>
					<%= submit_tag "Go", class: "btn btn-info"%>
				</div>
					<br/>
					<div class='pull-left-sm pull-right-md'>
						<%#= link_to "Advanced Query", '#', onclick: "$('#advanced_search').toggle()"%>
					</div>
			</div>
    <% end %>
	</div>
</div>

<div id='advanced_search' class='well form-horizontal' style='display:none;width:100%'>
	<%= form_tag nil, method: :get do %>
		
		<div class='form-group'>
			<%= label_tag :title_query, "Title", class: 'col-sm-2' %>
			<div class='col-sm-8'>
				<%= text_field_tag :title_query, params[:title_query], class: 'form-control' %>
			</div>
		</div>
    
		<div class='form-group'>
			<%= label_tag :author_query, "Author", class: 'col-sm-2' %>
			<div class='col-sm-8'>
				<%= text_field_tag :author_query, params[:author_query], class: 'form-control' %>
			</div>
		</div>
		
		<div class='form-group'>
			<%= label_tag :abstract_query, "Abstract", class: 'col-sm-2' %>
			<div class='col-sm-8'>
				<%= text_field_tag :abstract_query, params[:abstract_query], class: 'form-control' %>
			</div>
		</div>
    
		<div class='form-group'>
			<%= label_tag :journal_query, "Journal", class: 'col-sm-2' %>
			<div class='col-sm-8'>
				<%= text_field_tag :journal_query, params[:journal_query], class: 'form-control' %>
			</div>
		</div>
    
		<div class='form-group'>
			<%= label_tag :year_query, "Year", class: 'col-sm-2' %>
			<div class='col-sm-8'>
				<%= text_field_tag :year_query, params[:year_query], class: 'form-control' %>
			</div>
		</div>
		
		<%= submit_tag "Search", class: "btn btn-info"%>
		<%= link_to "Clear Query", pubs_path, class: 'btn btn-warning pull-right' %>
	<% end %>
</div>

<div class='panel table-responsive'>
	
	<div class="panel-heading clearfix">
		<div class='pull-right'><%= page_entries_info @datasets %></div>
	</div>
	
  <table class='table table-striped'>
    <thead>
      <tr>
				<th style='width:15%'><%= sortable "pubs.wos_authors", "Authors" %></th>
				<th><%= sortable "pubs.wos_year", "Year"%></th>
				<th style='width: 20px'></th>
				<th style='width:15%'><%= sortable "pubs.wos_title", "Title" %></th>
				<th><%= sortable "pubs.wos_journal", "Journal" %></th>
				<th><%= sortable "pubs.doi", "DOI" %></th>
        <th><%= sortable('plants.genus','Genus') %></th>
        <th><%= sortable('plants.species','Species') %></th>
				<th><%= sortable('plants.variety', 'Variety') %></th>
				<th><%= sortable('plants.common_name','Common Name') %></th>
        <th><%= sortable('res.result_count','Data points') %></th>
        <th><%= sortable('res.result_total','Total Value') %></th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      <% @datasets.each do |dataset| %>
        <% publication = dataset.plants_pub.pub || Pub.new %>
        <% plant = dataset.plants_pub.plant || Plant.new %>
        <tr>
					<td><%= link_to publication.wos_authors||"Unknown", publication %></td>
          <td><%= link_to publication.wos_year||'-', publication %></td>
					<td class='pub-tooltip'>
						<% if publication.abstract %>
							<a tabindex="0" class="glyphicon glyphicon-text-color" role="button" data-toggle="popover" data-trigger="focus" title="Abstract" data-content="<%= publication.abstract %>"></a>
						<% end %>
					</td>
					<td><%= publication.wos_title %></td>
					<td><%= publication.wos_journal %></td>
					<td><%= link_to publication.doi, "https://doi.org/#{publication.doi}", target: '_blank' if publication.doi && publication.doi.downcase != 'none' %></td>
					<td><%= link_to plant.genus||'-', plant %></td>
					<td><%= link_to plant.species||'-', plant %></td>
					<td><%= plant.variety %></td>
					<td><%= plant.common_name %></td>
          <td><%= link_to dataset.result_count, results_path(plant_id: plant.id, pub_id: publication.id) if dataset.result_count %></td>
          <td><%= dataset.result_total.round(2) if dataset.result_total %></td>
          <td>
            <%= link_to 'Details', dataset %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
<div class='row'>
	<div class='col-xs-12 col-sm-7 col-md-8'>
		<ul class="pagination pull-left">
			<%= paginate @datasets %>
		</ul>
	</div>
</div>